# Full-Text Search

- PostgreSQL’s full-text search is **built into the core**, supports weighting, language dictionaries, ranking, and complex search logic.

**PostgreSQL**

```postgresql
-- Create a tsvector column and GIN index
ALTER TABLE articles ADD COLUMN tsv tsvector;

UPDATE articles
SET tsv = to_tsvector('english', title || ' ' || content);

CREATE INDEX idx_articles_tsv ON articles USING GIN(tsv);

-- Query
SELECT * FROM articles
WHERE tsv @@ plainto_tsquery('english', 'postgres tutorial');
```

**Example in dvdrental**

```postgresql
-- user_id is the primary key, meaning each user can have only one row in this table.
-- movie is just a text column storing the name of a bookmarked movie.
CREATE TABLE IF NOT EXISTS BOOKMARKS (USER_ID INT PRIMARY KEY, MOVIE TEXT);

INSERT INTO
	BOOKMARKS (USER_ID, MOVIE)
VALUES
	(1, 'Inception')
ON CONFLICT (USER_ID) DO UPDATE
SET
	MOVIE = EXCLUDED.MOVIE;

SELECT
	*
FROM
	BOOKMARKS;
```

**ON CONFLICT (user_id)**:

- If a row **already exists with `user_id = 1`** (i.e., there's a conflict on the primary key)...

**DO UPDATE**:

- Instead of throwing an error, PostgreSQL **updates** the existing row.

**SET movie = EXCLUDED.movie**:

- `EXCLUDED.movie` refers to the value we were trying to insert (`'Inception'`).
- So, it **updates the existing row’s `movie` column** to the new value.

![Upsert_Result](Imgs\Upsert_Result.png)

**MySQL**

```mysql
-- MySQL has FULLTEXT index but only on CHAR, VARCHAR, TEXT
CREATE FULLTEXT INDEX idx_title ON articles(title);

-- QUERY
SELECT * FROM articles
WHERE MATCH(title) AGAINST ('postgres tutorial');
```

---

# JSON and JSONB

- PostgreSQL’s `JSONB` supports **indexing**, **containment queries**, and performs better for complex reads.

**PostgreSQL**

```postgresql
CREATE TABLE users (
	id SERIAL PRIMARY KEY,
    profile JSONB
);

-- Query inside JSON
SELECT * FROM users
WHERE profile->> 'country' = 'Thailand';
```

**Example in dvdrental**

```postgresql
CREATE TABLE LOGS (ID SERIAL PRIMARY KEY, PAYLOAD JSONB);

-- Insert JSON
INSERT INTO
	LOGS (PAYLOAD)
VALUES
	(
		'{"action": "rent", "user_id": 25, "movie": "Die Hard"}'
	);

SELECT
	*
FROM
	LOGS
WHERE
	PAYLOAD ->> 'user_id' = '25';
```

![JSONB_Result](Imgs\JSONB_Result.png)

**MySQL**

```mysql
CREATE TABLE users (
	id INT AUTO_INCREMENT PRIMARY KEY,
    profile JSON
);

-- Query inside JSON
SELECT * FROM users
WHERE JSON_UNQUOTE(JSON_EXTRACT(profile, '$.country')) = 'Thailand';
```

