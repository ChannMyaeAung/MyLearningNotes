# PostgreSQL Transaction

- A PostgreSQL transaction is atomic, consistent, isolated, and durable. These properties are often referred to collectively as ACID:
  - **Atomicity** guarantees that the transaction is completed in an all-or-nothing manner.
  - **Consistency** ensures that changes to data written to the database are valid and adhere to predefined rules.
  - **Isolation** determines how the integrity of a transaction is visible to other transactions.
  - **Durability** ensures that transactions that have been committed are permanently stored in the database.

---

## Example

```postgresql
DROP TABLE IF EXISTS accounts;

CREATE TABLE accounts (
id INT GENERATED BY DEFAULT AS IDENTITY,
name VARCHAR(100) NOT NULL,
balance DEC(15, 2) NOT NULL CHECK(balance >= 0),
PRIMARY KEY(id)
);

INSERT INTO accounts(name, balance)
VALUES('Bob', 10000);
```

```bash
postgres=# \c dvdrental
You are now connected to database "dvdrental" as user "postgres".
dvdrental=# SELECT * FROM accounts;
 id | name | balance
----+------+----------
  1 | Bob  | 10000.00
(1 row)
```

### Begin a transaction

- When executing a statement, PostgreSQL implicitly wraps it in a transaction.

```postgresql
BEGIN TRANSACTION;

-- OR

BEGIN WORK;

-- OR 

BEGIN;
```

```postgresql
BEGIN TRANSACTION;

INSERT INTO accounts(name, balance)
VALUES('Alice', 10000);

SELECT id, name, balance 
FROM accounts;
```

![Transaction](Imgs\Transaction.png)

## Commit a transaction

- To permanently apply the change to the database, we commit the transaction.

```postgresql
COMMIT WORK;

-- OR

COMMIT TRANSACTION;

-- OR 
COMMIT;
```

- After executing the `COMMIT` statement, PostgreSQL guarantees that the change will be durable if a crash happens.

```postgresql
DROP TABLE IF EXISTS accounts;

CREATE TABLE accounts (
id INT GENERATED BY DEFAULT AS IDENTITY,
name VARCHAR(100) NOT NULL,
balance DEC(15, 2) NOT NULL CHECK(balance >= 0),
PRIMARY KEY(id)
);

INSERT INTO accounts(name, balance)
VALUES('Bob', 10000);

SELECT * FROM accounts;

-- start a transaction
BEGIN TRANSACTION;

INSERT INTO accounts(name, balance)
VALUES('Alice', 10000);

SELECT id, name, balance 
FROM accounts;

-- commit the change (or roll it back later)
COMMIT;
```

### Roll back a transaction

```postgresql
ROLLBACK;

-- OR
ROLLBACK TRANSACTION;

-- OR
ROLLBACK WORK;
```

```postgresql
BEGIN;

UPDATE accounts
SET balance = balance - 1000
WHERE id = 1;

SELECT * FROM accounts;
```

![Transaction_Result_2](Imgs\Transaction_Result_2.png)

```postgresql
ROLLBACK;

SELECT * FROM accounts;
```

![Transaction_Result_Rollback](Imgs\Transaction_Result_Rollback.png)