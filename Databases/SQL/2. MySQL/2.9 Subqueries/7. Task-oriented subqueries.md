# Task-oriented subqueries

```bash
mysql> SELECT c.first_name, c.last_name, ct.city,
    -> sum(p.amount) tot_payments, count(*) tot_rentals
    -> FROM payment p
    -> INNER JOIN customer c
    -> ON p.customer_id = c.customer_id
    -> INNER JOIN address a
    -> ON c.address_id = a.address_id
    -> INNER JOIN city ct
    -> ON a.city_id = ct.city_id
    -> GROUP BY c.first_name, c.last_name, ct.city;
+-------------+--------------+----------------------------+--------------+-------------+
| first_name  | last_name    | city                       | tot_payments | tot_rentals |
+-------------+--------------+----------------------------+--------------+-------------+
| JULIE       | SANCHEZ      | A Coruña (La Coruña)       |       107.71 |          29 |
| PEGGY       | MYERS        | Abha                       |        96.76 |          24 |
| TOM         | MILNER       | Abu Dhabi                  |       107.68 |          32 |
| GLEN        | TALBERT      | Acuña                      |       113.74 |          26 |
| LARRY       | THRASHER     | Adana                      |       112.74 |          26 |
| SEAN        | DOUGLASS     | Addis Abeba                |        91.77 |          23 |
| ELLA        | OLIVER       | Aden                       |       137.69 |          31 |
| ADAM        | GOOCH        | Adoni                      |       101.78 |          22 |
| SHERRI      | RHODES       | Ahmadnagar                 |       128.6
...
...
...
1 |          29 |
| GUY         | BROWNLEE     | Zhoushan                   |       159.68 |          32 |
| RONNIE      | RICKETTS     | Ziguinchor                 |       100.75 |          25 |
+-------------+--------------+----------------------------+--------------+-------------+
599 rows in set (0.06 sec)
```

- The `customer`, `address`, and `city` tables are needed only for display purposes and that the `payment` table has everything needed to generate the groupings (`customer_id` and `amount`).
- Thus, we could separate out the task of generating the groups into a subquery and then join the other three tables to the table generated by the subquery to achieve the desired end result.

**The grouping subquery**

```bash
mysql> SELECT customer_id,
    ->   count(*) tot_rentals, sum(amount) tot_payments
    -> FROM payment
    -> GROUP BY customer_id;
...
...
|         595 |          30 |       117.70 |
|         596 |          28 |        96.72 |
|         597 |          25 |        99.75 |
|         598 |          22 |        83.78 |
|         599 |          19 |        83.81 |
+-------------+-------------+--------------+
599 rows in set (0.02 sec)
```

- This is the heart of the query.
- The other tables are needed only to provided meaningful strings in place of the `customer_id` value.
- The following query joins the previous data set to the other three tables.
  - this version may execute faster as well, because the grouping is being done on a single numeric column (`customer_id`) instead of multiple lengthy string columns (`customer.first_name`, `customer.last_name`, `city.city`).

```bash
mysql> SELECT c.first_name, c.last_name,
    ->   ct.city,
    ->   pymnt.tot_payments, pymnt.tot_rentals
    -> FROM
    ->  (SELECT customer_id,
    ->     count(*) tot_rentals, sum(amount) tot_payments
    ->   FROM payment
    ->   GROUP BY customer_id
    ->  ) pymnt
    ->   INNER JOIN customer c
    ->   ON pymnt.customer_id = c.customer_id
    ->   INNER JOIN address a
    ->   ON c.address_id = a.address_id
    ->   INNER JOIN city ct
    ->   ON a.city_id = ct.city_id;
...
...
...
5 |          25 |
| JACK        | FOUST        | Zeleznogorsk               |        89.76 |          24 |
| BYRON       | BOX          | Zhezqazghan                |       120.71 |          29 |
| GUY         | BROWNLEE     | Zhoushan                   |       159.68 |          32 |
| RONNIE      | RICKETTS     | Ziguinchor                 |       100.75 |          25 |
+-------------+--------------+----------------------------+--------------+-------------+
599 rows in set (0.01 sec)
```

